<!DOCTYPE html>
<html>
<head>
	<title>map</title>
   <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">

  <!-- Firebase References -->
  <script src="https://www.gstatic.com/firebasejs/6.0.4/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/6.0.4/firebase-database.js"></script>
  <!-- jQuery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 500px;
        width: 700px;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>

  <body>


  <h1 id=test-line></h1>
  <form id="movie-form">
      <label for="event-input">Search event</label>
      <input type="text" id="event-input">
      <br>
      <!-- Button triggers new movie to be added -->
      <input id="event-genre" type="submit" value="Add a genre">
    </form>

    <br>
    <br>
 
    <div id="map" height></div>
     

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBUhoVJmCEDevCj8e82oFi0Vn8UB4uqFvg&callback=initMap"
    async defer></script>
    <script>

    var locations = [];

    var labels = [];

    var userlong;
    var userlat;  
    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition);
      } else {
        console.log("Geolocation is not supported by this browser.");
      }
    }
    function showPosition(position) {
      console.log("Latitude: " + position.coords.latitude + 
      " Longitude: " + position.coords.longitude) 
      userlong = position.coords.longitude;
      userlat = position.coords.latitude;
    }

    
    
    getLocation();
    function displayEvent() {
        
        var genre = [{
          id:3001,
          name:"alternative"
        },
        {id:3002,
        name:"blues & jazz"},
        {id:3003,
        name:"classical"},
        {id:3004,
        name:"country"},
        {id:3005,
        name:"culture"},
        {id:3006,
        name:"edm/electronic"},
        {id:3007,
        name:"folk"},
        {id:3008,
        name:"hip hop/rap"},
        {id:3009,
        name:"indie"},
        {id:3010,
        name:"latin"},
        {id:3011,
        name:"metal"},
        {id:3012,
        name:"opera"},
        {id:3013,
        name:"pop"},
        {id:3014,
        name:"r&b"},
        {id:3015,
        name:"reggae"},
        {id:3016,
        name:"religious/spiritual"},
        {id:3017,
        name:"rock"},
        {id:3018,
        name:"top 40"},
        {id:3099,
        name:"other"}];
        var eventGenre = $("#event-input").val();
        eventGenre = eventGenre.toLowerCase();
        console.log("this is event genre" +eventGenre);
        for (i=0; i <genre.length; i++){
          if (eventGenre == genre[i].name){
            eventGenre = genre[i].id;
          }
        }
        console.log("the Event genre id is: " +eventGenre);
        var queryURL ="https://www.eventbriteapi.com/v3/events/search/?categories=103&subcategories=" + eventGenre +"&token=HCI6R2VNZXBSOAT5UBT2&expand=venue&location.latitude=" + userlat + "&location.longitude=" + userlong + "&location.within=100mi";
        $.ajax({
          url: queryURL,
          method: "GET"
        }).then(function(response) {
          console.log(response); 
          
          for (n=0;n<10;n++) {
            var eventloc = [];
            eventloc.push(response.events[n].venue.latitude)
            eventloc.push(response.events[n].venue.longitude)
            locations.push(eventloc)
            labels.push("<div><b>Event:</b> " + response.events[n].name.html + "</div><div><b>Venue:</b> " + response.events[n].venue.name)

          }
          console.log(locations)
        });
      }
      $("#event-genre").on("click", function(event) {
        event.preventDefault();
  displayEvent();
      });
        
        
     
    	
      function initMap() {

        var myLatlng = new google.maps.LatLng(userlat, userlong)
     
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 8,
          center: myLatlng
        });
        
        var bounds = new google.maps.LatLngBounds();
        
        $("#event-genre").on("click", function(event) {
          event.preventDefault();
            console.log(locations.length)
            var marker;

            $(document).ajaxComplete( function() {
			// loop through locations and add to map
			for ( var i = 0; i < locations.length; i++ )
			{
				// get current location
				var location = locations[ i ];
				
				// create map position
				var position = new google.maps.LatLng( location[ 0 ], location[ 1 ] );
				
				// add position to bounds
				bounds.extend( position );
				
				// create marker (https://developers.google.com/maps/documentation/javascript/reference#MarkerOptions)
				marker = new google.maps.Marker({
					/*animation: google.maps.Animation.DROP */
					  map: map
					, position: position
					, title: location[ 0 ]
        });
				
				// create info window and add to marker (https://developers.google.com/maps/documentation/javascript/reference#InfoWindowOptions)
				google.maps.event.addListener( marker, 'click', ( 
					function( marker, i ) {
						return function() {
							var infowindow = new google.maps.InfoWindow();
							infowindow.setContent( labels[i]);
							infowindow.open( map, marker );
						}
					}
				)( marker, i ) );
            };
          })
        })


 		var infoWindow = new google.maps.InfoWindow;
		if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };

            infoWindow.setPosition(pos);
            infoWindow.setContent('Location found.');
            infoWindow.open(map);
            map.setCenter(pos);
          }, function() {
            handleLocationError(true, infoWindow, map.getCenter());
          });
        } else {
          // Browser doesn't support Geolocation
          handleLocationError(false, infoWindow, map.getCenter());
        }
    

      function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
                              'Error: The Geolocation service failed.' :
                              'Error: Your browser does not support geolocation.');
        infoWindow.open(map);
      }

    }
    
    </script>
   
  </body>

</html>